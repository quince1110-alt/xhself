import streamlit as st
import pandas as pd
import google.generativeai as genai
import time
import io
import os
import requests
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import A4
from reportlab.lib.colors import HexColor
import matplotlib.pyplot as plt
import seaborn as sns

# ================= é…ç½®åŒºåŸŸ =================
st.set_page_config(
    page_title="å°çº¢ä¹¦è´¦å·ICUæ€¥æ•‘ç«™",
    page_icon="ğŸ¥",
    layout="wide"
)

# ç³»ç»Ÿæç¤ºè¯ (æ¯’èˆŒç‰ˆ)
SYSTEM_PROMPT = """
# Role: å°çº¢ä¹¦çˆ†æ¬¾è¯Šæ–­ä¸“å®¶
ä½ æ˜¯ä¸€åæ‹¥æœ‰ç™¾ä¸‡ç²‰ä¸æ“ç›˜ç»éªŒçš„å°çº¢ä¹¦è¿è¥ä¸“å®¶ã€‚ä½ è¯´è¯é£æ ¼çŠ€åˆ©ã€æ¯’èˆŒã€æ‹’ç»åºŸè¯ï¼Œåªçœ‹æ•°æ®å’Œäººæ€§ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„ç¬”è®°æ ‡é¢˜å’Œæ•°æ®ï¼Œè¿›è¡Œâ€œæ— æƒ…â€çš„è¯Šæ–­ï¼Œå¹¶ç»™å‡ºæ”¹è¿›æ–¹æ¡ˆã€‚

è¯·é’ˆå¯¹æ¯ä¸€æ¡ç¬”è®°ï¼Œè¾“å‡ºä¸¥æ ¼çš„å¦‚ä¸‹æ ¼å¼ï¼ˆä¸è¦Markdownï¼Œåªè¦çº¯æ–‡æœ¬ï¼‰ï¼š
ã€è¯„åˆ†ã€‘: <0-100çš„æ•°å­—>
ã€æ¯’èˆŒè¯Šæ–­ã€‘: <ä¸€å¥è¯æŒ‡å‡ºé—®é¢˜ï¼Œå¦‚å¤ªå­¦æœ¯ã€æ— èŠã€è‡ªå—¨>
ã€æ”¹å†™æ–¹æ¡ˆAã€‘: <ç—›ç‚¹å‹æ ‡é¢˜>
ã€æ”¹å†™æ–¹æ¡ˆBã€‘: <åˆ©ç›Šå‹æ ‡é¢˜>
"""

# ================= è¾…åŠ©å‡½æ•°ï¼šå­—ä½“å¤„ç† =================
def get_chinese_font():
    """ä¸‹è½½ä¸­æ–‡å­—ä½“ï¼Œç¡®ä¿PDFä¸ä¹±ç """
    font_path = "SimHei.ttf"
    # å¦‚æœæœ¬åœ°æ²¡æœ‰å­—ä½“ï¼Œä»ç½‘ä¸Šä¸‹è½½ä¸€ä¸ªå¼€æºå­—ä½“ (è¿™é‡Œä½¿ç”¨ NotoSansSC çš„ä¸€ä¸ªç²¾ç®€ç‰ˆæˆ–è€…ç±»ä¼¼)
    # ä¸ºäº†æ¼”ç¤ºç¨³å®šï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ‰˜ç®¡çš„å­—ä½“é“¾æ¥ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¸Šä¼  SimHei.ttf åˆ°ä½ çš„ GitHub
    if not os.path.exists(font_path):
        with st.spinner("æ­£åœ¨åˆå§‹åŒ–å­—ä½“èµ„æºï¼ˆé¦–æ¬¡è¿è¡Œéœ€ä¸‹è½½ï¼‰..."):
            # è¿™é‡Œä½¿ç”¨ä¸€ä¸ªå¸¸ç”¨çš„å¼€æºä¸­æ–‡å­—ä½“é“¾æ¥ï¼Œå¦‚æœå¤±æ•ˆè¯·æ‰‹åŠ¨ä¸Šä¼  SimHei.ttf åˆ°ä»“åº“
            url = "https://github.com/StellarCN/scp_zh/raw/master/fonts/SimHei.ttf"
            try:
                r = requests.get(url)
                with open(font_path, "wb") as f:
                    f.write(r.content)
            except:
                st.error("å­—ä½“ä¸‹è½½å¤±è´¥ï¼Œè¯·åœ¨ GitHub ä»“åº“ä¸­æ‰‹åŠ¨ä¸Šä¼ ä¸€ä¸ª SimHei.ttf æ–‡ä»¶")
    return font_path

# ================= æ ¸å¿ƒåŠŸèƒ½ï¼šAI åˆ†æ =================
def analyze_note(model, title, likes, ctr):
    prompt = f"""
    ç¬”è®°æ ‡é¢˜ï¼š{title}
    æ•°æ®ï¼šç‚¹èµ {likes}, ç‚¹å‡»ç‡ {ctr}
    è¯·æŒ‰è¦æ±‚è¯Šæ–­ã€‚
    """
    try:
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"è¯Šæ–­å¤±è´¥: {str(e)}"

# ================= æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆ PDF =================
def create_pdf(df, analysis_results, charts_buffer):
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    # æ³¨å†Œå­—ä½“
    font_path = get_chinese_font()
    if os.path.exists(font_path):
        pdfmetrics.registerFont(TTFont('SimHei', font_path))
        font_name = 'SimHei'
    else:
        font_name = 'Helvetica' # é™çº§æ–¹æ¡ˆ
    
    # --- å°é¢ ---
    c.setFillColor(HexColor('#FF2442')) # å°çº¢ä¹¦çº¢
    c.rect(0, height - 100, width, 100, fill=1, stroke=0)
    
    c.setFillColor(HexColor('#FFFFFF'))
    c.setFont(font_name, 24)
    c.drawString(30, height - 60, "å°çº¢ä¹¦è´¦å·æ·±åº¦è¯Šæ–­æŠ¥å‘Š")
    c.setFont(font_name, 14)
    c.drawString(30, height - 85, "Generated by AI Strategy Studio")
    
    # --- æ’å…¥å›¾è¡¨ ---
    c.setFillColor(HexColor('#000000'))
    c.setFont(font_name, 16)
    c.drawString(30, height - 150, "ä¸€ã€æ•°æ®å¯è§†åŒ–è¯Šæ–­")
    
    # ä» buffer è¯»å–å›¾è¡¨å¹¶ç”»å…¥ PDF
    if charts_buffer:
        charts_buffer.seek(0)
        # Reportlab æ’å…¥å›¾ç‰‡éœ€è¦æ–‡ä»¶è·¯å¾„æˆ–ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡Œç®€åŒ–é€»è¾‘
        # ä¸ºäº†å…¼å®¹æ€§ï¼Œæˆ‘ä»¬å…ˆæŠŠ matplotlib å›¾ç‰‡å­˜ä¸´æ—¶æ–‡ä»¶
        with open("temp_chart.png", "wb") as f:
            f.write(charts_buffer.getbuffer())
        c.drawImage("temp_chart.png", 30, height - 450, width=500, height=280)
    
    # --- AI è¯Šæ–­åˆ—è¡¨ ---
    c.setFont(font_name, 16)
    y_position = height - 480
    c.drawString(30, y_position, "äºŒã€AI æ¯’èˆŒæ€¥æ•‘æ–¹æ¡ˆ")
    y_position -= 30
    
    c.setFont(font_name, 10)
    
    for item in analysis_results:
        if y_position < 100: # æ¢é¡µ
            c.showPage()
            c.setFont(font_name, 10)
            y_position = height - 50
            
        # è§£æ AI è¿”å›çš„æ–‡æœ¬ (ç®€å•å¤„ç†)
        text_lines = item['result'].split('\n')
        
        # ç»˜åˆ¶èƒŒæ™¯å—
        c.setFillColor(HexColor('#F5F5F5'))
        c.rect(20, y_position - 70, width - 40, 80, fill=1, stroke=0)
        
        c.setFillColor(HexColor('#000000'))
        c.drawString(30, y_position - 15, f"ã€åŸæ ‡é¢˜ã€‘: {item['title']}")
        
        line_step = 15
        current_y = y_position - 30
        
        for line in text_lines:
            if line.strip():
                c.drawString(30, current_y, line.strip())
                current_y -= line_step
        
        y_position -= 100 # ä¸‹ä¸€æ¡ç¬”è®°çš„é—´è·
        
    c.save()
    buffer.seek(0)
    return buffer

# ================= ç•Œé¢é€»è¾‘ =================

# ä¾§è¾¹æ 
with st.sidebar:
    st.header("ğŸ”‘ è®¾ç½®")
    api_key = st.text_input("è¯·è¾“å…¥ Google API Key", type="password", help="å» aistudio.google.com å…è´¹ç”³è¯·")
    st.markdown("---")
    st.markdown("### ğŸ’¡ ä½¿ç”¨è¯´æ˜")
    st.markdown("1. ä¸Šä¼ å°çº¢ä¹¦åå°å¯¼å‡ºçš„ CSV/Excel")
    st.markdown("2. ç‚¹å‡»å¼€å§‹è¯Šæ–­")
    st.markdown("3. ç­‰å¾… AI åˆ†æ")
    st.markdown("4. ä¸‹è½½ PDF æŠ¥å‘Š")

# ä¸»ç•Œé¢
st.title("ğŸ¥ å°çº¢ä¹¦è´¦å· ICU æ€¥æ•‘ç«™")
st.markdown("##### å‡ åå—é’±çš„å’¨è¯¢å¤ªè´µï¼Ÿå…ˆèŠ± **0å…ƒ** ç”¨ AI æµ‹æµ‹ä½ çš„æ ‡é¢˜å«é‡‘é‡ï¼")

uploaded_file = st.file_uploader("ä¸Šä¼ ç¬”è®°æ•°æ®è¡¨", type=['xlsx', 'csv'])

if uploaded_file and api_key:
    # è¯»å–æ–‡ä»¶
    try:
        if uploaded_file.name.endswith('.csv'):
            df = pd.read_csv(uploaded_file)
        else:
            df = pd.read_excel(uploaded_file)
        
        st.success(f"âœ… æˆåŠŸè¯»å– {len(df)} æ¡æ•°æ®")
        
        # æ•°æ®é¢„è§ˆ
        with st.expander("ç‚¹å‡»æŸ¥çœ‹åŸå§‹æ•°æ®"):
            st.dataframe(df.head())
        
        # å¿…é¡»åŒ…å«çš„åˆ—åæ£€æµ‹ (æ ¹æ®ä½ çš„Excelè°ƒæ•´)
        title_col = st.selectbox("é€‰æ‹©ã€æ ‡é¢˜ã€‘åˆ—", df.columns)
        likes_col = st.selectbox("é€‰æ‹©ã€ç‚¹èµã€‘åˆ—", df.columns)
        
        # åªæœ‰ç‚¹å‡»æŒ‰é’®æ‰å¼€å§‹è·‘
        if st.button("ğŸš€ å¼€å§‹å…¨ç›˜æ‰«æ (AI Diagnosis)"):
            
            # 1. AI åˆ†æè¿‡ç¨‹
            genai.configure(api_key=api_key)
            model = genai.GenerativeModel('gemini-1.5-flash', system_instruction=SYSTEM_PROMPT)
            
            progress_bar = st.progress(0)
            status_text = st.empty()
            
            analysis_results = []
            
            # ä¸ºäº†æ¼”ç¤ºï¼Œåªå–å‰ 5 æ¡ (ä½ å¯ä»¥è‡ªå·±æ”¹æˆå…¨é‡)
            target_df = df.head(5) 
            
            for index, row in target_df.iterrows():
                status_text.text(f"æ­£åœ¨è¯Šæ–­ç¬¬ {index+1} æ¡: {row[title_col]}...")
                
                res_text = analyze_note(model, row[title_col], row[likes_col], "æœªçŸ¥")
                analysis_results.append({
                    "title": row[title_col],
                    "result": res_text
                })
                
                progress_bar.progress((index + 1) / len(target_df))
                time.sleep(1) # é˜²æ­¢ API é€Ÿç‡é™åˆ¶
            
            status_text.text("âœ… è¯Šæ–­å®Œæˆï¼æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...")
            
            # 2. ç”Ÿæˆå›¾è¡¨ (ç”¨äº PDF)
            st.subheader("ğŸ“Š è¯Šæ–­ç»“æœå¯è§†åŒ–")
            fig, ax = plt.subplots(figsize=(10, 5))
            # ç®€å•ç”»ä¸€ä¸ªç‚¹èµåˆ†å¸ƒå›¾
            sns.barplot(y=target_df[title_col].str[:10]+"...", x=target_df[likes_col], palette="viridis", ax=ax)
            
            # è®¾ç½®ä¸­æ–‡å­—ä½“ (Matplotlib)
            font_path = get_chinese_font()
            my_font =  pd.read_csv(io.StringIO(""), sep="\t") # Dummy
            if os.path.exists(font_path):
                import matplotlib.font_manager as fm
                prop = fm.FontProperties(fname=font_path)
                plt.yticks(fontproperties=prop)
            
            plt.title("ç¬”è®°ç‚¹èµè¡¨ç°", fontproperties=prop if os.path.exists(font_path) else None)
            st.pyplot(fig)
            
            # ä¿å­˜å›¾è¡¨åˆ°å†…å­˜
            img_buffer = io.BytesIO()
            plt.savefig(img_buffer, format='png', dpi=150, bbox_inches='tight')
            
            # 3. å±•ç¤º AI å»ºè®®æ–‡æœ¬
            st.subheader("ğŸ’Š AI æ¯’èˆŒå¤„æ–¹")
            for res in analysis_results:
                with st.chat_message("assistant"):
                    st.write(f"**åŸæ ‡é¢˜**: {res['title']}")
                    st.text(res['result']) # ä½¿ç”¨ text ä¿æŒæ ¼å¼
            
            # 4. ç”Ÿæˆ PDF ä¸‹è½½
            pdf_data = create_pdf(df, analysis_results, img_buffer)
            
            st.markdown("---")
            st.download_button(
                label="ğŸ“¥ ä¸‹è½½æ·±åº¦è¯Šæ–­æŠ¥å‘Š (.pdf)",
                data=pdf_data,
                file_name="å°çº¢ä¹¦è´¦å·è¯Šæ–­æŠ¥å‘Š.pdf",
                mime="application/pdf"
            )

    except Exception as e:
        st.error(f"å‘ç”Ÿé”™è¯¯: {e}")

elif not api_key:
    st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§è¾“å…¥ API Key æ‰èƒ½å¼€å§‹å·¥ä½œ")
